name: Scheduled Health Checks

on:
  # schedule:
    # Run every 6 hours
    # - cron: '0 */6 * * *'
  workflow_dispatch: # Allow manual trigger

env:
  NODE_VERSION: '18'

jobs:
  # Health Check - Test live application
  health-check:
    name: Application Health Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
        
    - name: Run deployment health tests
      run: npm run test:deployment
      continue-on-error: true
      
    - name: Test website accessibility
      run: |
        echo "Testing main website endpoints..."
        
        urls=(
          "https://resume-generator-ai.solutionsynth.cloud"
          "https://resume-generator-ai.solutionsynth.cloud/resume"
          "https://resume-generator-ai.solutionsynth.cloud/cover-letter"
        )
        
        for url in "${urls[@]}"; do
          echo "Testing $url"
          status=$(curl -s -o /dev/null -w "%{http_code}" "$url")
          if [ "$status" -eq 200 ]; then
            echo "‚úÖ $url - Status: $status"
          else
            echo "‚ùå $url - Status: $status"
            exit 1
          fi
        done
        
    - name: Test Lambda function URLs
      run: |
        echo "Testing Lambda function health..."
        
        # Test with minimal valid data
        resume_data='{"text":"John Doe\nSoftware Engineer","jobDescription":"Software Engineer position"}'
        cover_data='{"resumeText":"John Doe\nSoftware Engineer","jobDescription":"Software Engineer position","companyName":"Test Corp"}'
        
        # Test Resume Lambda
        echo "Testing Resume Lambda..."
        resume_status=$(curl -s -o /dev/null -w "%{http_code}" \
          -X POST \
          -H "Content-Type: application/json" \
          -d "$resume_data" \
          "https://rjstpa3gkzlyayomdodjl5dxju0uxeyg.lambda-url.us-east-1.on.aws/")
        
        if [ "$resume_status" -eq 200 ]; then
          echo "‚úÖ Resume Lambda - Status: $resume_status"
        else
          echo "‚ùå Resume Lambda - Status: $resume_status"
        fi
        
        # Test Cover Letter Lambda
        echo "Testing Cover Letter Lambda..."
        cover_status=$(curl -s -o /dev/null -w "%{http_code}" \
          -X POST \
          -H "Content-Type: application/json" \
          -d "$cover_data" \
          "https://exfj76qtfsswdyyhrrnuk7g3om0gwuwx.lambda-url.us-east-1.on.aws/")
        
        if [ "$cover_status" -eq 200 ]; then
          echo "‚úÖ Cover Letter Lambda - Status: $cover_status"
        else
          echo "‚ùå Cover Letter Lambda - Status: $cover_status"
        fi

  # AWS Resource Health Check
  aws-health-check:
    name: AWS Resources Health Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
        
    - name: Check S3 bucket health
      run: |
        echo "Checking S3 bucket health..."
        aws s3 ls s3://resume-generator-hosting-790756194179-us-east-1 > /dev/null
        echo "‚úÖ S3 bucket accessible"
        
    - name: Check CloudFront distribution
      run: |
        echo "Checking CloudFront distribution..."
        status=$(aws cloudfront get-distribution --id E2MF41024ZIBNU --query 'Distribution.Status' --output text)
        echo "CloudFront status: $status"
        if [ "$status" = "Deployed" ]; then
          echo "‚úÖ CloudFront distribution healthy"
        else
          echo "‚ö†Ô∏è CloudFront distribution status: $status"
        fi
        
    - name: Check Lambda function health
      run: |
        echo "Checking Lambda functions..."
        
        functions=(
          "ats-resume-generateResume"
          "ats-resume-generateCoverLetter"
          "ats-resume-processFile"
          "ats-resume-upload"
        )
        
        for func in "${functions[@]}"; do
          echo "Checking $func..."
          status=$(aws lambda get-function --function-name "$func" --query 'Configuration.State' --output text 2>/dev/null || echo "NOT_FOUND")
          if [ "$status" = "Active" ]; then
            echo "‚úÖ $func - Status: $status"
          else
            echo "‚ùå $func - Status: $status"
          fi
        done

  # Performance Monitoring
  performance-check:
    name: Performance Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Website Performance Test
      run: |
        echo "Testing website performance..."
        
        # Test main page load time
        start_time=$(date +%s%N)
        curl -s "https://resume-generator-ai.solutionsynth.cloud" > /dev/null
        end_time=$(date +%s%N)
        
        load_time=$(( (end_time - start_time) / 1000000 )) # Convert to milliseconds
        echo "Main page load time: ${load_time}ms"
        
        if [ "$load_time" -lt 3000 ]; then
          echo "‚úÖ Performance: Good (${load_time}ms < 3000ms)"
        elif [ "$load_time" -lt 5000 ]; then
          echo "‚ö†Ô∏è Performance: Acceptable (${load_time}ms < 5000ms)"
        else
          echo "‚ùå Performance: Poor (${load_time}ms >= 5000ms)"
        fi

  # Notify on failure
  notify-failure:
    name: Notify Health Check Failure
    runs-on: ubuntu-latest
    needs: [health-check, aws-health-check, performance-check]
    if: failure()
    
    steps:
    - name: Health Check Failed
      run: |
        echo "‚ùå Scheduled health check failed!"
        echo "One or more health checks have failed. Please investigate:"
        echo "- Application endpoints may be down"
        echo "- AWS resources may be unhealthy"
        echo "- Performance may be degraded"
        echo ""
        echo "Check the workflow logs for detailed information."
        
        # In a real setup, you might want to send notifications to Slack, email, etc.
        # Example: curl -X POST -H 'Content-type: application/json' --data '{"text":"Health check failed!"}' $SLACK_WEBHOOK_URL

  # Success summary
  health-summary:
    name: Health Check Summary
    runs-on: ubuntu-latest
    needs: [health-check, aws-health-check, performance-check]
    if: success()
    
    steps:
    - name: Health Check Success
      run: |
        echo "‚úÖ All health checks passed!"
        echo "üöÄ Application: https://resume-generator-ai.solutionsynth.cloud"
        echo "üìä All systems operational"