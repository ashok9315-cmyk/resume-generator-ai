name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'
  AWS_REGION: 'us-east-1'

jobs:
  # Test and Build Frontend
  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run ESLint
      run: npm run lint
      
    - name: Run tests
      run: npm test
      
    - name: Build Next.js app
      run: npm run build
      env:
        NEXT_PUBLIC_APP_URL: https://resume-generator-ai.solutionsynth.cloud
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nextjs-build
        path: out/
        retention-days: 7

  # Test Lambda Functions
  test-lambda:
    name: Test Lambda Functions
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        lambda: [processFile, upload, generateResume, generateCoverLetter]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install Lambda dependencies
      run: |
        cd lambda/${{ matrix.lambda }}
        npm ci
        
    - name: Build Lambda function
      run: |
        cd lambda/${{ matrix.lambda }}
        npm run build
        
    - name: Upload Lambda artifacts
      uses: actions/upload-artifact@v4
      with:
        name: lambda-${{ matrix.lambda }}
        path: lambda/${{ matrix.lambda }}/dist/
        retention-days: 7

  # Security Scan
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for proper comparison
      
    - name: Run npm audit
      run: npm audit --audit-level=high
      continue-on-error: true
      
    - name: Check for hardcoded secrets
      run: |
        echo "üîç Checking for potential hardcoded secrets..."
        
        # Check for Anthropic API keys (exclude workflow files and documentation)
        if grep -r "sk-ant-api" . --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=out --exclude-dir=.next --exclude-dir=.github --exclude="*.md"; then
          echo "‚ùå Found potential Anthropic API keys in code!"
          exit 1
        fi
        
        # Check for LangChain API keys (exclude workflow files and documentation)
        if grep -r "lsv2_pt_" . --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=out --exclude-dir=.next --exclude-dir=.github --exclude="*.md"; then
          echo "‚ùå Found potential LangChain keys in code!"
          exit 1
        fi
        
        # Check for AWS keys (exclude workflow files)
        if grep -r "AKIA[0-9A-Z]\{16\}" . --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=out --exclude-dir=.next --exclude-dir=.github --exclude="*.md"; then
          echo "‚ùå Found potential AWS access keys in code!"
          exit 1
        fi
        
        echo "‚úÖ No hardcoded secrets found in source code"
        
    - name: Run TruffleHog scan
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
        extra_args: --debug --only-verified
      continue-on-error: true  # Don't fail the build if TruffleHog has issues

  # Deploy to Production (only on main branch)
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [test-frontend, test-lambda, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment:
      name: production
      url: https://resume-generator-ai.solutionsynth.cloud
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install CDK dependencies
      run: |
        cd infrastructure
        npm ci
        
    - name: Install Lambda dependencies
      run: |
        for dir in lambda/*/; do
          if [ -f "${dir}package.json" ]; then
            echo "Installing dependencies for ${dir}"
            cd "${dir}"
            npm ci
            cd - > /dev/null
          fi
        done
        
    - name: Build Lambda functions
      run: |
        for dir in lambda/*/; do
          if [ -f "${dir}package.json" ] && [ -f "${dir}tsconfig.json" ]; then
            echo "Building ${dir}"
            cd "${dir}"
            npm run build
            cd - > /dev/null
          fi
        done
        
    - name: Deploy AWS infrastructure
      run: |
        cd infrastructure
        npx cdk deploy AtsResumeStack-production --require-approval never
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        LANGCHAIN_API_KEY: ${{ secrets.LANGCHAIN_API_KEY }}
        LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}
        
    - name: Build Next.js app
      run: npm run build
      env:
        NEXT_PUBLIC_APP_URL: https://resume-generator-ai.solutionsynth.cloud
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        
    - name: Deploy to S3
      run: |
        aws s3 sync out s3://resume-generator-hosting-790756194179-us-east-1 --delete
        
    - name: Invalidate CloudFront
      run: |
        aws cloudfront create-invalidation --distribution-id E2MF41024ZIBNU --paths "/*"
        
    - name: Run deployment tests
      run: npm run test:deployment
      continue-on-error: true

  # Notify deployment status
  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
    - name: Deployment Success
      if: needs.deploy-production.result == 'success'
      run: |
        echo "‚úÖ Deployment successful!"
        echo "üöÄ Application is live at: https://resume-generator-ai.solutionsynth.cloud"
        
    - name: Deployment Failed
      if: needs.deploy-production.result == 'failure'
      run: |
        echo "‚ùå Deployment failed!"
        echo "Check the logs above for details."
        exit 1